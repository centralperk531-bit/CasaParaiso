// ===== CONFIGURACI√ìN =====
const ADMIN_PASSWORD = "micampo2025";

// üî• IMPORTANTE: Cambia esta URL por la de TU Web App desplegada
const GOOGLE_SCRIPT_URL = https://script.google.com/macros/s/AKfycbwWRDsD3AQGmnLcYeEo_mRvp7hYg67X9dOnjC_FxOA6-IQXG7b_-2-6X76nyb94joT-/exec;

const CONFIG = {
    nombreCampo: "El Campo",
    descripcion: "Tu escapada rural perfecta",
    capacidad: "6 personas",
    precioPorNoche: 120,
    estanciaMinima: 2,
    se√±alPorcentaje: 30,
    tuEmail: "centralperk.531@gmail.com",
    datosPago: {
        titular: "Tu Nombre",
        iban: "ES00 0000 0000 0000 0000 0000",
        bizum: "600 123 456"
    }
};

const EMAILJS_CONFIG = {
    publicKey: "2y0y0PPlq0OgBw_lo",
    serviceId: "service_b443ulg",
    templateCliente: "template_q0w947d",
    templateAdmin: "template_iv17wmi"
};

// ===== VARIABLES GLOBALES =====
let fechasBloqueadas = [];
let preciosPersonalizados = {};
let modoAdmin = false;
let mesActual = new Date();
let reservas = [];
let fechaSeleccionadaAdmin = null;
let touchTimer = null;
let fechaEntradaSeleccionada = null;

// ===== FUNCIONES DE COMUNICACI√ìN CON GOOGLE SHEETS =====

async function cargarDatosGoogle() {
    try {
        // Cargar fechas bloqueadas
        const resFechas = await fetch(GOOGLE_SCRIPT_URL + '?accion=obtenerFechasBloqueadas');
        const dataFechas = await resFechas.json();
        
        if (dataFechas.success) {
            fechasBloqueadas = dataFechas.fechas || [];
            console.log('‚úÖ Fechas bloqueadas cargadas:', fechasBloqueadas.length);
        } else {
            console.error('‚ùå Error al cargar fechas:', dataFechas.message);
        }

        // Cargar precios personalizados
        const resPrecios = await fetch(GOOGLE_SCRIPT_URL + '?accion=obtenerPrecios');
        const dataPrecios = await resPrecios.json();
        
        if (dataPrecios.success) {
            preciosPersonalizados = dataPrecios.precios || {};
            console.log('‚úÖ Precios cargados:', Object.keys(preciosPersonalizados).length);
        } else {
            console.error('‚ùå Error al cargar precios:', dataPrecios.message);
        }

        // Cargar reservas (solo para admin)
        if (modoAdmin) {
            await cargarReservasGoogle();
        }

        generarCalendario();
        
    } catch (error) {
        console.error('‚ùå Error al cargar desde Google Sheets:', error);
        mostrarAlerta('‚ö†Ô∏è Error al cargar disponibilidad. Recarga la p√°gina.', 'error');
    }
}

async function cargarReservasGoogle() {
    try {
        const res = await fetch(GOOGLE_SCRIPT_URL + '?accion=obtenerReservas');
        const data = await res.json();
        
        if (data.success) {
            reservas = data.reservas || [];
            document.getElementById('totalReservas').textContent = reservas.length;
            console.log('‚úÖ Reservas cargadas:', reservas.length);
        }
    } catch (error) {
        console.error('‚ùå Error al cargar reservas:', error);
    }
}

async function guardarFechaBloqueada(fecha) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                accion: 'bloquearFecha',
                fecha: fecha
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Fecha bloqueada en Google Sheets');
            return true;
        } else {
            console.error('‚ùå Error:', data.message);
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error al guardar fecha:', error);
        return false;
    }
}

async function eliminarFechaBloqueada(fecha) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                accion: 'desbloquearFecha',
                fecha: fecha
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Fecha desbloqueada en Google Sheets');
            return true;
        } else {
            console.error('‚ùå Error:', data.message);
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error al desbloquear fecha:', error);
        return false;
    }
}

async function guardarPrecioGoogle(fecha, precio) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                accion: 'guardarPrecio',
                fecha: fecha,
                precio: parseFloat(precio)
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Precio guardado en Google Sheets');
            return true;
        } else {
            console.error('‚ùå Error:', data.message);
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error al guardar precio:', error);
        return false;
    }
}

async function guardarReservaGoogle(reserva) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                accion: 'guardarReserva',
                ...reserva
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Reserva guardada en Google Sheets');
            return true;
        } else {
            console.error('‚ùå Error:', data.message);
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error al guardar reserva:', error);
        return false;
    }
}

async function bloquearRangoGoogle(fechas) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                accion: 'bloquearRango',
                fechas: fechas
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Rango bloqueado en Google Sheets');
            return true;
        } else {
            console.error('‚ùå Error:', data.message);
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error al bloquear rango:', error);
        return false;
    }
}

// ===== FUNCIONES DE ADMIN =====

async function bloquearFecha() {
    if (!fechasBloqueadas.includes(fechaSeleccionadaAdmin)) {
        const exito = await guardarFechaBloqueada(fechaSeleccionadaAdmin);
        
        if (exito) {
            fechasBloqueadas.push(fechaSeleccionadaAdmin);
            generarCalendario();
            cerrarActionMenu();
            mostrarAlerta('‚úì Fecha bloqueada', 'success');
        } else {
            mostrarAlerta('‚ùå Error al bloquear', 'error');
        }
    } else {
        mostrarAlerta('Ya est√° bloqueada', 'error');
    }
}

async function desbloquearFecha() {
    const index = fechasBloqueadas.indexOf(fechaSeleccionadaAdmin);
    
    if (index > -1) {
        const exito = await eliminarFechaBloqueada(fechaSeleccionadaAdmin);
        
        if (exito) {
            fechasBloqueadas.splice(index, 1);
            generarCalendario();
            cerrarActionMenu();
            mostrarAlerta('‚úì Fecha desbloqueada', 'success');
        } else {
            mostrarAlerta('‚ùå Error al desbloquear', 'error');
        }
    } else {
        mostrarAlerta('No est√° bloqueada', 'error');
    }
}

async function guardarPrecio() {
    const precio = document.getElementById('nuevoPrecio').value;
    
    if (!precio || precio <= 0) {
        mostrarAlerta('Precio no v√°lido', 'error');
        return;
    }
    
    const exito = await guardarPrecioGoogle(fechaSeleccionadaAdmin, precio);
    
    if (exito) {
        preciosPersonalizados[fechaSeleccionadaAdmin] = parseFloat(precio);
        cerrarModal('modalPrecio');
        document.getElementById('nuevoPrecio').value = '';
        generarCalendario();
        mostrarAlerta(`‚úì Precio: ${precio}‚Ç¨`, 'success');
    } else {
        mostrarAlerta('‚ùå Error al guardar precio', 'error');
    }
}

async function confirmarReserva(index) {
    if (!confirm('¬øConfirmar reserva? Se bloquear√°n las fechas.')) return;
    
    const r = reservas[index];
    
    // Generar array de fechas a bloquear
    const fechasABloquear = [];
    const fechaInicio = new Date(r.fechaEntrada + 'T12:00:00');
    const fechaFin = new Date(r.fechaSalida + 'T12:00:00');
    
    for (let d = new Date(fechaInicio); d < fechaFin; d.setDate(d.getDate() + 1)) {
        const fechaStr = d.toISOString().split('T')[0];
        if (!fechasBloqueadas.includes(fechaStr)) {
            fechasABloquear.push(fechaStr);
        }
    }
    
    // Bloquear rango en Google Sheets
    const exito = await bloquearRangoGoogle(fechasABloquear);
    
    if (exito) {
        fechasBloqueadas.push(...fechasABloquear);
        reservas[index].confirmada = true;
        localStorage.setItem('reservas', JSON.stringify(reservas));
        generarCalendario();
        mostrarReservas();
        mostrarAlerta('‚úì Confirmada y bloqueada', 'success');
    } else {
        mostrarAlerta('‚ùå Error al confirmar', 'error');
    }
}

function eliminarReserva(index) {
    if (!confirm('¬øEliminar reserva?')) return;
    
    const r = reservas[index];
    
    // Si estaba confirmada, desbloquear fechas
    if (r.confirmada) {
        const fechaInicio = new Date(r.fechaEntrada + 'T12:00:00');
        const fechaFin = new Date(r.fechaSalida + 'T12:00:00');
        
        for (let d = new Date(fechaInicio); d < fechaFin; d.setDate(d.getDate() + 1)) {
            const fechaStr = d.toISOString().split('T')[0];
            const idx = fechasBloqueadas.indexOf(fechaStr);
            if (idx > -1) {
                fechasBloqueadas.splice(idx, 1);
                eliminarFechaBloqueada(fechaStr);
            }
        }
        generarCalendario();
    }
    
    reservas.splice(index, 1);
    localStorage.setItem('reservas', JSON.stringify(reservas));
    document.getElementById('totalReservas').textContent = reservas.length;
    mostrarReservas();
    mostrarAlerta('‚úì Eliminada', 'success');
}

// ===== RESTO DE FUNCIONES (las que ya ten√≠as) =====

function validarDNI(dni) {
    const dniRegex = /^[0-9]{8}[A-Z]$/i;
    if (!dniRegex.test(dni)) return false;
    
    const letras = 'TRWAGMYFPDXBNJZSQVHLCKE';
    const numero = dni.substr(0, 8);
    const letra = dni.substr(8, 1).toUpperCase();
    
    return letras.charAt(numero % 23) === letra;
}

function generarCalendario() {
    const a√±o = mesActual.getFullYear();
    const mes = mesActual.getMonth();
    
    const primerDia = new Date(a√±o, mes, 1);
    const ultimoDia = new Date(a√±o, mes + 1, 0);
    const diasMes = ultimoDia.getDate();
    const primerDiaSemana = primerDia.getDay();
    
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    
    document.getElementById('mesActual').textContent = `${meses[mes]} ${a√±o}`;
    
    const calendario = document.getElementById('calendario');
    calendario.innerHTML = '';
    
    const dias = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
    dias.forEach(dia => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.textContent = dia;
        calendario.appendChild(header);
    });
    
    for (let i = 0; i < primerDiaSemana; i++) {
        calendario.appendChild(document.createElement('div'));
    }
    
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    
    for (let dia = 1; dia <= diasMes; dia++) {
        const fecha = new Date(a√±o, mes, dia);
        const fechaStr = fecha.toISOString().split('T')[0];
        
        const diaDiv = document.createElement('div');
        diaDiv.className = 'calendar-day';
        diaDiv.innerHTML = `<strong>${dia}</strong>`;
        diaDiv.dataset.fecha = fechaStr;
        
        const esBloqueado = fechasBloqueadas.includes(fechaStr);
        const precioPersonalizado = preciosPersonalizados[fechaStr];
        
        if (precioPersonalizado) {
            diaDiv.innerHTML += `<div class="precio-dia">${precioPersonalizado}‚Ç¨</div>`;
        }
        
        if (fecha < hoy) {
            diaDiv.classList.add('past');
        } else if (esBloqueado) {
            diaDiv.classList.add('blocked');
            diaDiv.innerHTML += '<div style="font-size: 0.65rem;">üî¥</div>';
        } else {
            diaDiv.classList.add('available');
            diaDiv.innerHTML += '<div style="font-size: 0.65rem;">üü¢</div>';
        }
        
        const entradaSel = document.getElementById('fechaEntrada').value;
        const salidaSel = document.getElementById('fechaSalida').value;
        
        if (entradaSel && salidaSel) {
            if (fechaStr >= entradaSel && fechaStr <= salidaSel) {
                diaDiv.classList.add('selected');
            }
        } else if (fechaEntradaSeleccionada === fechaStr) {
            diaDiv.classList.add('selected');
        }
        
        if (fecha >= hoy) {
            if (modoAdmin) {
                diaDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    mostrarActionMenu(fechaStr);
                    return false;
                });
                
                diaDiv.addEventListener('touchstart', () => {
                    touchTimer = setTimeout(() => {
                        mostrarActionMenu(fechaStr);
                    }, 600);
                });
                
                diaDiv.addEventListener('touchend', () => clearTimeout(touchTimer));
                diaDiv.addEventListener('touchmove', () => clearTimeout(touchTimer));
                
            } else if (!esBloqueado) {
                diaDiv.addEventListener('click', (e) => {
                    e.preventDefault();
                    seleccionarFechaCliente(fechaStr);
                });
            }
        }
        
        calendario.appendChild(diaDiv);
    }
}

function cambiarMes(dir) {
    mesActual.setMonth(mesActual.getMonth() + dir);
    generarCalendario();
}

function seleccionarFechaCliente(fecha) {
    const entrada = document.getElementById('fechaEntrada');
    const salida = document.getElementById('fechaSalida');
    
    if (fechaEntradaSeleccionada === fecha && !salida.value) {
        limpiarFechas();
        mostrarAlerta('‚úì Fechas limpiadas', 'success');
        return;
    }
    
    if (entrada.value && salida.value) {
        if (fecha >= entrada.value && fecha <= salida.value) {
            limpiarFechas();
            mostrarAlerta('‚úì Fechas limpiadas. Selecciona de nuevo', 'success');
            return;
        }
    }
    
    if (!fechaEntradaSeleccionada) {
        fechaEntradaSeleccionada = fecha;
        entrada.value = fecha;
        salida.value = '';
        generarCalendario();
        mostrarAlerta('‚úì Entrada: ' + new Date(fecha + 'T12:00:00').toLocaleDateString('es-ES') + '. Selecciona salida', 'success');
    } else {
        if (fecha > fechaEntradaSeleccionada) {
            salida.value = fecha;
            calcularResumen();
            generarCalendario();
            mostrarAlerta('‚úì Fechas seleccionadas', 'success');
        } else {
            entrada.value = fecha;
            salida.value = '';
            fechaEntradaSeleccionada = fecha;
            generarCalendario();
            mostrarAlerta('‚úì Nueva entrada. Selecciona salida', 'success');
        }
    }
}

function limpiarFechas() {
    document.getElementById('fechaEntrada').value = '';
    document.getElementById('fechaSalida').value = '';
    document.getElementById('resumenReserva').style.display = 'none';
    fechaEntradaSeleccionada = null;
    generarCalendario();
}

function mostrarActionMenu(fecha) {
    fechaSeleccionadaAdmin = fecha;
    const fechaObj = new Date(fecha + 'T00:00:00');
    const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {day: 'numeric', month: 'long'});
    document.getElementById('actionMenuTitle').textContent = fechaFormateada;
    document.getElementById('actionMenu').classList.add('show');
    
    if (navigator.vibrate) {
        navigator.vibrate(50);
    }
}

function cerrarActionMenu() {
    document.getElementById('actionMenu').classList.remove('show');
}

function mostrarModalPrecio() {
    cerrarActionMenu();
    const fecha = new Date(fechaSeleccionadaAdmin + 'T00:00:00');
    const fechaFormateada = fecha.toLocaleDateString('es-ES');
    document.getElementById('fechasParaPrecio').innerHTML = 
        `<p style="margin-bottom: 1rem;"><strong>Fecha:</strong> ${fechaFormateada}</p>`;
    document.getElementById('modalPrecio').classList.add('show');
}

function mostrarLoginAdmin() {
    document.getElementById('modalLoginAdmin').classList.add('show');
}

async function verificarPassword() {
    const password = document.getElementById('passwordAdmin').value;
    if (password === ADMIN_PASSWORD) {
        modoAdmin = true;
        document.getElementById('adminPanel').classList.add('show');
        cerrarModal('modalLoginAdmin');
        document.getElementById('passwordAdmin').value = '';
        
        // Cargar reservas desde Google Sheets
        await cargarReservasGoogle();
        
        generarCalendario();
        mostrarAlerta('‚úì Modo admin activado', 'success');
    } else {
        mostrarAlerta('Contrase√±a incorrecta', 'error');
    }
}

function cerrarAdmin() {
    modoAdmin = false;
    document.getElementById('adminPanel').classList.remove('show');
    generarCalendario();
    mostrarAlerta('‚úì Modo cliente', 'success');
}

function mostrarReservas() {
    const listado = document.getElementById('listadoReservas');
    if (reservas.length === 0) {
        listado.innerHTML = '<p style="text-align: center; color: #999;">Sin reservas</p>';
    } else {
        listado.innerHTML = reservas.map((r, index) => `
            <div class="reserva-item">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <strong style="font-size: 1rem;">${r.nombre}</strong>
                    ${r.confirmada ? '<span style="background: #28a745; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">‚úì OK</span>' : '<span style="background: #ffc107; color: #333; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">‚è≥ Pend</span>'}
                </div>
                ${r.dni} | üìß ${r.email}<br>
                üìû ${r.telefono} | üë• ${r.personas}<br>
                üìÖ ${r.fechaEntrada} ‚Üí ${r.fechaSalida}<br>
                üí∞ ${r.total}‚Ç¨ (Se√±al: ${r.se√±al}‚Ç¨)<br>
                ${r.comentarios ? 'üí¨ ' + r.comentarios + '<br>' : ''}
                <small>${r.fechaReserva}</small>
                <div style="display: grid; grid-template-columns: ${!r.confirmada ? '1fr 1fr' : '1fr'}; gap: 0.5rem; margin-top: 0.8rem;">
                    ${!r.confirmada ? `<button class="btn btn-success" style="padding: 0.6rem; font-size: 0.85rem;" onclick="confirmarReserva(${index})">‚úì Confirmar</button>` : ''}
                    <button class="btn btn-danger" style="padding: 0.6rem; font-size: 0.85rem;" onclick="eliminarReserva(${index})">üóëÔ∏è Borrar</button>
                </div>
            </div>
        `).join('');
    }
    document.getElementById('modalReservas').classList.add('show');
}

function descargarReservas() {
    if (reservas.length === 0) {
        mostrarAlerta('No hay reservas', 'error');
        return;
    }
    
    let csv = 'Fecha,Nombre,DNI,Email,Telefono,Personas,Entrada,Salida,Noches,Total,Se√±al,Estado,Comentarios\n';
    reservas.forEach(r => {
        csv += `"${r.fechaReserva}","${r.nombre}","${r.dni}","${r.email}","${r.telefono}",${r.personas},"${r.fechaEntrada}","${r.fechaSalida}",${r.noches},${r.total},${r.se√±al},"${r.confirmada ? 'Confirmada' : 'Pendiente'}","${r.comentarios || ''}"\n`;
    });
    
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `reservas_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    mostrarAlerta('‚úì Descargado', 'success');
}

function cerrarModal(id) {
    document.getElementById(id).classList.remove('show');
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
    }
    if (event.target.id === 'actionMenu') {
        cerrarActionMenu();
    }
}

function calcularResumen() {
    const entrada = document.getElementById('fechaEntrada').value;
    const salida = document.getElementById('fechaSalida').value;
    
    if (entrada && salida) {
        const fechaEntrada = new Date(entrada + 'T12:00:00');
        const fechaSalida = new Date(salida + 'T12:00:00');
        const noches = Math.round((fechaSalida - fechaEntrada) / (1000 * 60 * 60 * 24));
        
        if (noches < CONFIG.estanciaMinima) {
            mostrarAlerta(`M√≠nimo ${CONFIG.estanciaMinima} noches`, 'error');
            document.getElementById('resumenReserva').style.display = 'none';
            return;
        }
        
        if (noches > 0) {
            let total = 0;
            for (let i = 0; i < noches; i++) {
                const fecha = new Date(entrada + 'T12:00:00');
                fecha.setDate(fecha.getDate() + i);
                const fechaStr = fecha.toISOString().split('T')[0];
                const precio = preciosPersonalizados[fechaStr] || CONFIG.precioPorNoche;
                total += parseFloat(precio);
            }
            
            const se√±al = (total * CONFIG.se√±alPorcentaje) / 100;
            
            document.getElementById('resumenReserva').style.display = 'block';
            document.getElementById('resumenNoches').textContent = noches;
            document.getElementById('resumenTotal').textContent = total.toFixed(2);
            document.getElementById('resumenSe√±al').textContent = se√±al.toFixed(2);
        }
    }
}

// ===== ENVIAR RESERVA =====

document.getElementById('reservaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const dniInput = document.getElementById('dni');
    if (!validarDNI(dniInput.value)) {
        mostrarAlerta('DNI no v√°lido', 'error');
        dniInput.focus();
        return;
    }
    
    const btnEnviar = document.getElementById('btnEnviar');
    const loader = document.getElementById('loader');
    
    btnEnviar.disabled = true;
    loader.style.display = 'block';
    
    try {
        const reserva = {
            fechaReserva: new Date().toLocaleString('es-ES'),
            nombre: document.getElementById('nombre').value,
            dni: dniInput.value.toUpperCase(),
            email: document.getElementById('email').value,
            telefono: document.getElementById('telefono').value,
            personas: document.getElementById('personas').value,
            fechaEntrada: document.getElementById('fechaEntrada').value,
            fechaSalida: document.getElementById('fechaSalida').value,
            noches: document.getElementById('resumenNoches').textContent,
            total: document.getElementById('resumenTotal').textContent,
            se√±al: document.getElementById('resumenSe√±al').textContent,
            comentarios: document.getElementById('comentarios').value,
            nombreCampo: CONFIG.nombreCampo,
            confirmada: false
        };
        
        // Guardar en Google Sheets
        const exitoGoogle = await guardarReservaGoogle(reserva);
        
        if (!exitoGoogle) {
            throw new Error('Error al guardar en Google Sheets');
        }
        
        // Email al cliente
        await emailjs.send(
            EMAILJS_CONFIG.serviceId,
            EMAILJS_CONFIG.templateCliente,
            {
                to_email: reserva.email,
                to_name: reserva.nombre,
                ...reserva
            }
        );
        
        // Email al admin
        await emailjs.send(
            EMAILJS_CONFIG.serviceId,
            EMAILJS_CONFIG.templateAdmin,
            {
                to_email: CONFIG.tuEmail,
                ...reserva
            }
        );
        
        // Guardar tambi√©n en localStorage como backup
        reservas.push(reserva);
        localStorage.setItem('reservas', JSON.stringify(reservas));
        document.getElementById('totalReservas').textContent = reservas.length;
        
        // Limpiar formulario
        document.getElementById('reservaForm').reset();
        document.getElementById('resumenReserva').style.display = 'none';
        fechaEntradaSeleccionada = null;
        generarCalendario();
        
        // Mostrar popup de confirmaci√≥n
        document.getElementById('emailConfirmacion').textContent = CONFIG.tuEmail;
        document.getElementById('modalConfirmacion').classList.add('show');
        
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('‚ùå Error al enviar. Int√©ntalo de nuevo.', 'error');
    } finally {
        btnEnviar.disabled = false;
        loader.style.display = 'none';
    }
});

function mostrarAlerta(mensaje, tipo) {
    const container = document.getElementById('alertContainer');
    container.innerHTML = `<div class="alert ${tipo} show">${mensaje}</div>`;
    setTimeout(() => {
        container.innerHTML = '';
    }, 4000);
}

// ===== INICIALIZACI√ìN =====

// Inicializar EmailJS
(function() {
    emailjs.init(EMAILJS_CONFIG.publicKey);
})();

// Cargar datos del localStorage (backup)
const reservasGuardadas = localStorage.getItem('reservas');
if (reservasGuardadas) {
    reservas = JSON.parse(reservasGuardadas);
    document.getElementById('totalReservas').textContent = reservas.length;
}

// Rellenar informaci√≥n en el HTML
document.getElementById('headerNombre').textContent = CONFIG.nombreCampo;
document.getElementById('headerDescripcion').textContent = CONFIG.descripcion;
document.getElementById('infoCapacidad').textContent = CONFIG.capacidad;
document.getElementById('infoPrecio').textContent = CONFIG.precioPorNoche + '‚Ç¨';
document.getElementById('infoEstancia').textContent = CONFIG.estanciaMinima + ' noches';
document.getElementById('infoSe√±al').textContent = CONFIG.se√±alPorcentaje + '%';
document.getElementById('pagoTitular').textContent = CONFIG.datosPago.titular;
document.getElementById('pagoIban').textContent = CONFIG.datosPago.iban;
document.getElementById('pagoBizum').textContent = CONFIG.datosPago.bizum;
document.getElementById('footerNombre').textContent = CONFIG.nombreCampo;
document.getElementById('footerEmail').textContent = CONFIG.tuEmail;

// Validaci√≥n DNI en tiempo real
document.getElementById('dni').addEventListener('input', function(e) {
    const dni = e.target.value.toUpperCase();
    const validation = document.getElementById('dniValidation');
    
    if (dni.length === 0) {
        e.target.className = '';
        validation.textContent = '8 n√∫meros + letra';
        validation.className = 'validation-message error';
        return;
    }
    
    if (dni.length === 9) {
        if (validarDNI(dni)) {
            e.target.className = 'valid';
            validation.textContent = '‚úì V√°lido';
            validation.className = 'validation-message success';
        } else {
            e.target.className = 'invalid';
            validation.textContent = '‚úó No v√°lido';
            validation.className = 'validation-message error';
        }
    } else {
        e.target.className = 'invalid';
        validation.textContent = '8 n√∫meros + letra';
        validation.className = 'validation-message error';
    }
});

// Configurar fechas m√≠nimas
const hoy = new Date().toISOString().split('T')[0];
document.getElementById('fechaEntrada').setAttribute('min', hoy);
document.getElementById('fechaSalida').setAttribute('min', hoy);

// Cargar datos desde Google Sheets al iniciar
cargarDatosGoogle();

console.log('‚úÖ Sistema inicializado correctamente');
